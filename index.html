<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Int√©rprete de Pseudoc√≥digo - Bloques y Texto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            width: 100vw;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .credits {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }
        .mode-switcher {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .mode-btn {
            padding: 10px 30px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: white;
            color: #2196F3;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .blocks-panel {
            width: 280px;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .panel-section { margin-bottom: 25px; }
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .workspace {
            flex: 1;
            background: #f0f0f0;
            position: relative;
            overflow-y: scroll;
            overflow-x: auto;
            padding: 20px;
            background-image: radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .workspace.hidden { display: none; }
        .workspace-content {
            min-height: 3000px;
            position: relative;
            width: 100%;
            transform-origin: top left;
            transition: transform 0.2s ease;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .zoom-btn:hover {
            background: #2196F3;
            color: white;
            transform: scale(1.1);
        }
        .zoom-level {
            padding: 0 12px;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: #2196F3;
        }
        .text-editor-panel {
            flex: 1;
            background: #1e1e1e;
            padding: 20px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            position: relative;
        }
        .text-editor-panel.active { display: flex; }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .editor-header h3 { margin: 0; color: #4CAF50; }
        .editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .examples-selector {
            background: #2d2d2d;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }
        .examples-selector:hover {
            background: #3d3d3d;
            border-color: #66BB6A;
        }
        .editor-zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            background: #2d2d2d;
            padding: 5px 10px;
            border-radius: 6px;
        }
        .editor-zoom-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #4CAF50;
            background: #1e1e1e;
            color: #4CAF50;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .editor-zoom-btn:hover {
            background: #4CAF50;
            color: #1e1e1e;
        }
        .editor-zoom-level {
            color: #4CAF50;
            font-size: 12px;
            font-weight: bold;
            padding: 0 10px;
        }
        .code-editor-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .code-editor-container {
            position: relative;
            flex: 1;
            border: 3px solid #4CAF50;
            border-radius: 8px;
            overflow: hidden;
        }
        .syntax-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            background: #2d2d2d;
            color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            pointer-events: none;
            z-index: 1;
        }
        .keyword { color: #FFD700; font-weight: bold; }
        .code-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            background: transparent;
            color: transparent;
            caret-color: #4CAF50;
            resize: none;
            line-height: 1.8;
            transition: font-size 0.2s;
            border: none;
            z-index: 2;
        }
        .code-editor:focus { outline: none; }
        .code-editor-container:focus-within {
            border-color: #66BB6A;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        .autocomplete-popup {
            position: fixed;
            background: #2d2d2d;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #3d3d3d;
            transition: background 0.2s;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: #3d3d3d;
        }
        .autocomplete-keyword {
            color: #FFD700;
            font-weight: bold;
            font-size: 14px;
            display: block;
            margin-bottom: 4px;
        }
        .autocomplete-description {
            color: #888;
            font-size: 11px;
            font-style: italic;
        }
        .tooltip {
            position: fixed;
            background: #2d2d2d;
            color: #d4d4d4;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            padding: 12px;
            max-width: 350px;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-size: 12px;
            line-height: 1.6;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0;
        }
        .controls-panel {
            width: 300px;
            background: #f8f9fa;
            border-left: 3px solid #2196F3;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .palette-block {
            margin: 8px 0;
            cursor: grab;
            user-select: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .palette-block:hover { transform: scale(1.02); }
        .palette-block:active { cursor: grabbing; }
        .block-control { background: #FFAB19; color: white; }
        .block-data { background: #FF6680; color: white; }
        .block-operator { background: #59C059; color: white; }
        .block-condition { background: #5CB1D6; color: white; }
        .workspace-block {
            position: absolute;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 10;
            min-width: 180px;
        }
        .workspace-block.selected {
            outline: 3px solid #2196F3;
            outline-offset: 2px;
        }
        .workspace-block.executing {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.8);
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .block-slot {
            display: inline-block;
            min-width: 60px;
            min-height: 24px;
            background: rgba(255,255,255,0.3);
            border: 2px dashed rgba(255,255,255,0.6);
            border-radius: 4px;
            padding: 2px 6px;
            margin: 0 4px;
            vertical-align: middle;
            cursor: pointer;
            transition: all 0.2s;
        }
        .block-slot:hover {
            background: rgba(255,255,255,0.5);
            border-color: white;
        }
        .block-slot.filled {
            background: rgba(255,255,255,0.8);
            border: 2px solid white;
            color: #333;
            font-weight: bold;
        }
        .block-input {
            background: rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: white;
            min-width: 100px;
            margin: 0 4px;
            font-weight: 500;
        }
        .block-input::placeholder { color: rgba(255,255,255,0.6); }
        .block-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .block-container {
            border: 2px dashed rgba(255,255,255,0.4);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            min-height: 60px;
            background: rgba(0,0,0,0.1);
            position: relative;
        }
        .block-container.drop-active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            border-style: solid;
        }
        .nested-block {
            position: relative;
            margin: 5px 0;
            display: block;
        }
        .variable-item {
            background: #FF6680;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 4px;
            display: inline-block;
            cursor: grab;
            font-size: 11px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .variable-item:active { cursor: grabbing; }
        .btn-create-var {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-execute { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
        .btn-reset { background: linear-gradient(45deg, #ff9800, #f57c00); color: white; }
        .btn-clear { background: linear-gradient(45deg, #f44336, #d32f2f); color: white; }
        .btn-delete { background: linear-gradient(45deg, #f44336, #d32f2f); color: white; font-size: 14px; }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .output-area {
            min-height: 150px;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .variables-display {
            min-height: 100px;
            padding: 15px;
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 6px;
            font-size: 12px;
        }
        .variable-value-item {
            display: flex;
            justify-content: space-between;
            padding: 6px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
        }
        .var-name { font-weight: bold; color: #1976D2; }
        .var-value { color: #4CAF50; font-weight: bold; }
        .block-start, .block-end {
            border-radius: 20px;
            text-align: center;
            font-weight: bold;
        }
        #selectedBlockInfo {
            margin-top: 10px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 11px;
            min-height: 50px;
            color: #666;
            border: 2px solid #ddd;
        }
        #selectedBlockInfo.active {
            background: #e3f2fd;
            color: #1976D2;
            border-color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="credits">DESIGNED BY HANSEL PE√ëA<br>üìû 3143090748</div>
            <h1>üß© Int√©rprete de Pseudoc√≥digo</h1>
            <p>Programa con bloques visuales o c√≥digo de texto</p>
            <div class="mode-switcher">
                <button class="mode-btn active" id="btnModeBlocks">üß© Modo Bloques</button>
                <button class="mode-btn" id="btnModeText">üìù Modo Texto</button>
            </div>
        </div>

        <div class="main-content">
            <div class="blocks-panel">
                <div class="panel-section">
                    <div class="panel-title">‚öôÔ∏è Control</div>
                    <div class="palette-block block-control" draggable="true" data-type="start">üèÅ INICIO</div>
                    <div class="palette-block block-control" draggable="true" data-type="end">üèÅ FIN</div>
                    <div class="palette-block block-condition" draggable="true" data-type="if">üîÄ SI... ENTONCES</div>
                    <div class="palette-block block-condition" draggable="true" data-type="else">üîÑ SINO</div>
                    <div class="palette-block block-control" draggable="true" data-type="while" style="background: #9C27B0;">üîÅ MIENTRAS</div>
                    <div class="palette-block block-control" draggable="true" data-type="for" style="background: #673AB7;">üîÇ PARA</div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">üíæ Datos</div>
                    <div class="palette-block block-data" draggable="true" data-type="input">üì• LEER DEL TECLADO</div>
                    <div class="palette-block block-data" draggable="true" data-type="output">üì§ ESCRIBIR EN PANTALLA</div>
                    <div class="palette-block block-operator" draggable="true" data-type="calculate">üßÆ CALCULAR</div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">üìã Variables</div>
                    <button class="btn-create-var" id="btnCreateVar">+ Crear Variable</button>
                    <div id="variablesList"></div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-title">üî¢ Funciones</div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 6px;"><strong>a % b</strong> ‚Üí M√≥dulo</div>
                        <div style="margin-bottom: 6px;"><strong>sqrt(n)</strong> ‚Üí Ra√≠z</div>
                        <div style="margin-bottom: 6px;"><strong>pow(a,b)</strong> ‚Üí Potencia</div>
                        <div style="margin-bottom: 6px;"><strong>abs(n)</strong> ‚Üí Absoluto</div>
                        <div><strong>floor(n)</strong> ‚Üí Redondear</div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-title">üóëÔ∏è Eliminar Bloque</div>
                    <p style="font-size: 11px; color: #666; margin-bottom: 10px;">1. Clic en bloque<br>2. Presiona eliminar</p>
                    <button class="btn-delete" id="btnDelete">üóëÔ∏è Eliminar</button>
                    <div id="selectedBlockInfo">Ning√∫n bloque seleccionado</div>
                </div>
            </div>

            <div class="workspace" id="workspace">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="btnZoomOut" title="Alejar">-</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="btnZoomIn" title="Acercar">+</button>
                    <button class="zoom-btn" id="btnZoomReset" title="Restablecer" style="width: auto; padding: 0 10px;">‚ü≤</button>
                </div>
                <div class="workspace-content" id="workspaceContent">
                    <p style="color: #999; text-align: center; margin-top: 100px;" id="emptyMessage">
                        Arrastra bloques aqu√≠ para construir tu programa
                    </p>
                </div>
            </div>
            
            <div class="text-editor-panel" id="textEditorPanel">
                <div class="editor-header">
                    <h3>‚úçÔ∏è Editor de Pseudoc√≥digo</h3>
                    <div class="editor-controls">
                        <select class="examples-selector" id="examplesSelector">
                            <option value="">üìö Cargar Ejemplo...</option>
                            <option value="sequential">üìù Secuencial</option>
                            <option value="loop">üîÇ Bucle</option>
                            <option value="conditional">üîÄ Condicional</option>
                            <option value="complex">üßÆ Factorial</option>
                        </select>
                        <div class="editor-zoom-controls">
                            <button class="editor-zoom-btn" id="editorZoomOut">-</button>
                            <span class="editor-zoom-level" id="editorZoomLevel">100%</span>
                            <button class="editor-zoom-btn" id="editorZoomIn">+</button>
                            <button class="editor-zoom-btn" id="editorZoomReset" style="width: auto; padding: 0 8px;">‚ü≤</button>
                        </div>
                    </div>
                </div>

                <div class="code-editor-wrapper">
                    <div class="code-editor-container" id="editorContainer">
                        <div class="syntax-highlight" id="syntaxHighlight"></div>
                        <textarea class="code-editor" id="codeEditor" placeholder="Escribe tu pseudoc√≥digo aqu√≠... (Presiona Ctrl+Espacio para autocompletar)

Ejemplo:
INICIO
    LEER numero 'Ingrese un n√∫mero'
    ESCRIBIR 'El n√∫mero es:' numero
FIN" spellcheck="false"></textarea>
                    </div>
                    <div class="autocomplete-popup" id="autocompletePopup"></div>
                    <div class="tooltip" id="tooltip"></div>
                </div>
                
                <div class="action-buttons">
                    <button id="btnTextToBlocks" style="flex: 1; background: linear-gradient(45deg, #4CAF50, #45a049); color: white;">
                        üß© Convertir a Bloques
                    </button>
                    <button id="btnExecuteText" style="flex: 1; background: linear-gradient(45deg, #2196F3, #1976D2); color: white;">
                        ‚ñ∂Ô∏è Ejecutar C√≥digo
                    </button>
                </div>
            </div>

            <div class="controls-panel">
                <div class="panel-title">üéÆ Controles</div>
                <button class="btn-execute" id="btnExecute">‚ñ∂Ô∏è Ejecutar Programa</button>
                <button class="btn-reset" id="btnReset">üîÑ Reiniciar</button>
                <button class="btn-clear" id="btnClear">üóëÔ∏è Limpiar Todo</button>
                
                <div class="panel-title" style="margin-top: 20px;">üíæ Archivo</div>
                <button id="btnSave" style="background: linear-gradient(45deg, #673AB7, #512DA8); color: white;">üíæ Guardar Algoritmo</button>
                <button id="btnLoad" style="background: linear-gradient(45deg, #00897B, #00695C); color: white;">üìÇ Abrir Algoritmo</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">

                <div class="panel-title">üñ•Ô∏è Salida del Programa</div>
                <div class="output-area" id="outputArea">El resultado aparecer√° aqu√≠...</div>

                <div class="panel-title">üìä Variables en Memoria</div>
                <div class="variables-display" id="variablesDisplay">
                    <p style="color: #666; font-size: 11px;">Las variables aparecer√°n durante la ejecuci√≥n...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let app = { blocks: [], variables: {}, output: [], variableNames: [], blockCounter: 0, selectedBlockId: null, zoomLevel: 1, editorZoomLevel: 100, currentMode: 'blocks', autocompleteIndex: 0 };
        
        const keywords = {
            'INICIO': { description: 'Marca el comienzo del algoritmo', syntax: 'INICIO' },
            'FIN': { description: 'Marca el final del algoritmo', syntax: 'FIN' },
            'LEER': { description: 'Lee un valor del usuario y lo guarda en una variable', syntax: "LEER variable 'mensaje opcional'" },
            'ESCRIBIR': { description: 'Muestra un mensaje o valor en la pantalla', syntax: "ESCRIBIR 'mensaje' variable" },
            'CALCULAR': { description: 'Realiza una operaci√≥n matem√°tica y guarda el resultado', syntax: 'CALCULAR variable = expresi√≥n' },
            'SI': { description: 'Eval√∫a una condici√≥n y ejecuta c√≥digo si es verdadera', syntax: 'SI condici√≥n ENTONCES\n    instrucciones\nFIN_SI' },
            'ENTONCES': { description: 'Indica el bloque de c√≥digo que se ejecuta si la condici√≥n es verdadera', syntax: 'SI condici√≥n ENTONCES' },
            'SINO': { description: 'Indica el c√≥digo alternativo si la condici√≥n es falsa', syntax: 'SINO\n    instrucciones\nFIN_SINO' },
            'FIN_SI': { description: 'Cierra el bloque condicional SI', syntax: 'FIN_SI' },
            'FIN_SINO': { description: 'Cierra el bloque SINO', syntax: 'FIN_SINO' },
            'MIENTRAS': { description: 'Repite un bloque de c√≥digo mientras la condici√≥n sea verdadera', syntax: 'MIENTRAS condici√≥n HACER\n    instrucciones\nFIN_MIENTRAS' },
            'HACER': { description: 'Indica el inicio del bloque de c√≥digo del ciclo MIENTRAS', syntax: 'MIENTRAS condici√≥n HACER' },
            'FIN_MIENTRAS': { description: 'Cierra el ciclo MIENTRAS', syntax: 'FIN_MIENTRAS' },
            'PARA': { description: 'Repite un bloque de c√≥digo un n√∫mero espec√≠fico de veces', syntax: 'PARA variable DESDE inicio HASTA fin\n    instrucciones\nFIN_PARA' },
            'DESDE': { description: 'Indica el valor inicial del contador en el ciclo PARA', syntax: 'PARA variable DESDE inicio HASTA fin' },
            'HASTA': { description: 'Indica el valor final del contador en el ciclo PARA', syntax: 'PARA variable DESDE inicio HASTA fin' },
            'FIN_PARA': { description: 'Cierra el ciclo PARA', syntax: 'FIN_PARA' }
        };

        const examples = {
            sequential: `INICIO\n    LEER numero1 'Ingrese el primer n√∫mero'\n    LEER numero2 'Ingrese el segundo n√∫mero'\n    CALCULAR suma = numero1 + numero2\n    ESCRIBIR 'La suma es:' suma\nFIN`,
            loop: `INICIO\n    LEER numero 'Ingrese un n√∫mero para ver su tabla'\n    ESCRIBIR 'Tabla de multiplicar del' numero\n    PARA i DESDE 1 HASTA 10\n        CALCULAR resultado = numero * i\n        ESCRIBIR numero '*' i '=' resultado\n    FIN_PARA\nFIN`,
            conditional: `INICIO\n    LEER numero 'Ingrese un n√∫mero entero'\n    CALCULAR resto = numero % 2\n    SI resto == 0 ENTONCES\n        ESCRIBIR 'El n√∫mero' numero 'es PAR'\n    FIN_SI\n    SINO\n        ESCRIBIR 'El n√∫mero' numero 'es IMPAR'\n    FIN_SINO\nFIN`,
            complex: `INICIO\n    LEER n 'Ingrese un n√∫mero para calcular su factorial'\n    CALCULAR factorial = 1\n    CALCULAR contador = 1\n    MIENTRAS contador <= n HACER\n        CALCULAR factorial = factorial * contador\n        CALCULAR contador = contador + 1\n    FIN_MIENTRAS\n    ESCRIBIR 'El factorial de' n 'es:' factorial\nFIN`
        };

        function init() {
            setupEventListeners();
            setupEditorFeatures();
            
            document.getElementById('btnCreateVar').onclick = createVariable;
            document.getElementById('btnExecute').onclick = executeProgram;
            document.getElementById('btnReset').onclick = resetExecution;
            document.getElementById('btnClear').onclick = clearWorkspace;
            document.getElementById('btnDelete').onclick = deleteSelectedBlock;
            
            document.getElementById('btnZoomIn').onclick = zoomIn;
            document.getElementById('btnZoomOut').onclick = zoomOut;
            document.getElementById('btnZoomReset').onclick = zoomReset;
            
            document.getElementById('btnSave').onclick = saveAlgorithm;
            document.getElementById('btnLoad').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = loadAlgorithm;
            
            document.getElementById('btnModeBlocks').onclick = () => switchMode('blocks');
            document.getElementById('btnModeText').onclick = () => switchMode('text');
            document.getElementById('btnTextToBlocks').onclick = convertTextToBlocks;
            document.getElementById('btnExecuteText').onclick = executeTextCode;

            document.getElementById('examplesSelector').onchange = function() {
                if (this.value) {
                    loadExample(this.value);
                    this.value = '';
                }
            };
        }

        function loadExample(type) {
            document.getElementById('codeEditor').value = examples[type];
            updateSyntaxHighlight();
        }

        function setupEditorFeatures() {
            const editor = document.getElementById('codeEditor');
            const highlight = document.getElementById('syntaxHighlight');

            document.getElementById('editorZoomIn').onclick = () => adjustEditorZoom(10);
            document.getElementById('editorZoomOut').onclick = () => adjustEditorZoom(-10);
            document.getElementById('editorZoomReset').onclick = () => {
                app.editorZoomLevel = 100;
                editor.style.fontSize = '14px';
                highlight.style.fontSize = '14px';
                document.getElementById('editorZoomLevel').textContent = '100%';
            };

            editor.addEventListener('scroll', () => {
                highlight.scrollTop = editor.scrollTop;
                highlight.scrollLeft = editor.scrollLeft;
            });

            editor.addEventListener('input', (e) => {
                updateSyntaxHighlight();
                
                const text = e.target.value;
                const cursorPos = e.target.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s+/);
                const currentWord = words[words.length - 1].toUpperCase();

                if (currentWord.length > 0) {
                    const matches = Object.keys(keywords).filter(k => k.startsWith(currentWord));
                    if (matches.length > 0) {
                        showAutocomplete(matches, e.target, cursorPos);
                    } else {
                        document.getElementById('autocompletePopup').style.display = 'none';
                    }
                } else {
                    document.getElementById('autocompletePopup').style.display = 'none';
                }
            });

            editor.addEventListener('keydown', (e) => {
                const autocomplete = document.getElementById('autocompletePopup');
                
                if (autocomplete.style.display === 'block') {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        if (items.length > 0) {
                            items[app.autocompleteIndex].classList.remove('selected');
                            app.autocompleteIndex = (app.autocompleteIndex + 1) % items.length;
                            items[app.autocompleteIndex].classList.add('selected');
                            items[app.autocompleteIndex].scrollIntoView({ block: 'nearest' });
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        if (items.length > 0) {
                            items[app.autocompleteIndex].classList.remove('selected');
                            app.autocompleteIndex = (app.autocompleteIndex - 1 + items.length) % items.length;
                            items[app.autocompleteIndex].classList.add('selected');
                            items[app.autocompleteIndex].scrollIntoView({ block: 'nearest' });
                        }
                    } else if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        if (items.length > 0) items[app.autocompleteIndex].click();
                    } else if (e.key === 'Escape') {
                        autocomplete.style.display = 'none';
                    }
                }

                if (e.ctrlKey && e.key === ' ') {
                    e.preventDefault();
                    showAllKeywords(e.target);
                }
            });

            updateSyntaxHighlight();
        }

        function updateSyntaxHighlight() {
            const editor = document.getElementById('codeEditor');
            const highlight = document.getElementById('syntaxHighlight');
            const text = editor.value;
            
            let highlighted = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            Object.keys(keywords).forEach(keyword => {
                const regex = new RegExp('\\b' + keyword + '\\b', 'g');
                highlighted = highlighted.replace(regex, `<span class="keyword">${keyword}</span>`);
            });
            
            highlight.innerHTML = highlighted;
        }

        function adjustEditorZoom(delta) {
            const editor = document.getElementById('codeEditor');
            const highlight = document.getElementById('syntaxHighlight');
            app.editorZoomLevel = Math.max(60, Math.min(200, app.editorZoomLevel + delta));
            const fontSize = (14 * app.editorZoomLevel) / 100;
            editor.style.fontSize = `${fontSize}px`;
            highlight.style.fontSize = `${fontSize}px`;
            document.getElementById('editorZoomLevel').textContent = `${app.editorZoomLevel}%`;
        }

        function showAutocomplete(matches, editor, cursorPos) {
            const autocomplete = document.getElementById('autocompletePopup');
            autocomplete.innerHTML = '';
            app.autocompleteIndex = 0;

            matches.forEach((keyword, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item' + (index === 0 ? ' selected' : '');
                item.innerHTML = `<span class="autocomplete-keyword">${keyword}</span><span class="autocomplete-description">${keywords[keyword].description}</span>`;
                item.onclick = () => {
                    const text = editor.value;
                    const before = text.substring(0, cursorPos);
                    const after = text.substring(cursorPos);
                    const words = before.split(/\s+/);
                    const currentWord = words[words.length - 1];
                    const newBefore = before.substring(0, before.length - currentWord.length) + keyword;
                    editor.value = newBefore + after;
                    editor.selectionStart = editor.selectionEnd = newBefore.length;
                    autocomplete.style.display = 'none';
                    editor.focus();
                    updateSyntaxHighlight();
                };
                autocomplete.appendChild(item);
            });

            const coords = getCaretCoordinates(editor, cursorPos);
            autocomplete.style.left = `${coords.left}px`;
            autocomplete.style.top = `${coords.top + 20}px`;
            autocomplete.style.display = 'block';
        }

        function showAllKeywords(editor) {
            const allKeywords = Object.keys(keywords);
            const cursorPos = editor.selectionStart;
            showAutocomplete(allKeywords, editor, cursorPos);
        }

        function getCaretCoordinates(editor, position) {
            const text = editor.value.substring(0, position);
            const lines = text.split('\n');
            const lineHeight = parseInt(window.getComputedStyle(editor).lineHeight);
            const charWidth = parseInt(window.getComputedStyle(editor).fontSize) * 0.6;
            
            const line = lines.length - 1;
            const col = lines[lines.length - 1].length;
            
            const rect = editor.getBoundingClientRect();
            const scrollTop = editor.scrollTop;
            const scrollLeft = editor.scrollLeft;
            
            return {
                left: rect.left + (col * charWidth) + 15 - scrollLeft,
                top: rect.top + (line * lineHeight) + 15 - scrollTop + window.pageYOffset
            };
        }
        
        function switchMode(mode) {
            app.currentMode = mode;
            
            const workspace = document.getElementById('workspace');
            const textPanel = document.getElementById('textEditorPanel');
            const btnBlocks = document.getElementById('btnModeBlocks');
            const btnText = document.getElementById('btnModeText');
            
            if (mode === 'blocks') {
                workspace.classList.remove('hidden');
                textPanel.classList.remove('active');
                btnBlocks.classList.add('active');
                btnText.classList.remove('active');
            } else {
                workspace.classList.add('hidden');
                textPanel.classList.add('active');
                btnBlocks.classList.remove('active');
                btnText.classList.add('active');
                convertBlocksToText();
            }
        }
        
        function convertBlocksToText() {
            const topBlocks = app.blocks.filter(b => !b.isNested).sort((a, b) => a.y - b.y);
            let code = '';
            
            for (const block of topBlocks) {
                code += blockToText(block, 0);
            }
            
            document.getElementById('codeEditor').value = code || '// Arrastra bloques en modo Bloques o escribe c√≥digo aqu√≠';
            updateSyntaxHighlight();
        }
        
        function blockToText(block, indent = 0) {
            const spaces = '    '.repeat(indent);
            let text = '';
            
            switch(block.type) {
                case 'start': text = spaces + 'INICIO\n'; break;
                case 'end': text = spaces + 'FIN\n'; break;
                case 'input':
                    const inputMsg = block.data.message ? ` '${block.data.message}'` : '';
                    text = spaces + `LEER ${block.data.variable || 'variable'}${inputMsg}\n`;
                    break;
                case 'output':
                    const outputMsg = block.data.message ? `'${block.data.message}' ` : '';
                    const outputVar = block.data.variable || '';
                    text = spaces + `ESCRIBIR ${outputMsg}${outputVar}\n`;
                    break;
                case 'calculate':
                    text = spaces + `CALCULAR ${block.data.targetVar || 'variable'} = ${block.data.expression || ''}\n`;
                    break;
                case 'if':
                    text = spaces + `SI ${block.data.condition || 'condici√≥n'} ENTONCES\n`;
                    if (block.children && block.children.length > 0) {
                        for (const childId of block.children) {
                            const child = app.blocks.find(b => b.id === childId);
                            if (child) text += blockToText(child, indent + 1);
                        }
                    }
                    text += spaces + 'FIN_SI\n';
                    break;
                case 'else':
                    text = spaces + 'SINO\n';
                    if (block.children && block.children.length > 0) {
                        for (const childId of block.children) {
                            const child = app.blocks.find(b => b.id === childId);
                            if (child) text += blockToText(child, indent + 1);
                        }
                    }
                    text += spaces + 'FIN_SINO\n';
                    break;
                case 'while':
                    text = spaces + `MIENTRAS ${block.data.condition || 'condici√≥n'} HACER\n`;
                    if (block.children && block.children.length > 0) {
                        for (const childId of block.children) {
                            const child = app.blocks.find(b => b.id === childId);
                            if (child) text += blockToText(child, indent + 1);
                        }
                    }
                    text += spaces + 'FIN_MIENTRAS\n';
                    break;
                case 'for':
                    text = spaces + `PARA ${block.data.variable || 'i'} DESDE ${block.data.start || '1'} HASTA ${block.data.end || '10'}\n`;
                    if (block.children && block.children.length > 0) {
                        for (const childId of block.children) {
                            const child = app.blocks.find(b => b.id === childId);
                            if (child) text += blockToText(child, indent + 1);
                        }
                    }
                    text += spaces + 'FIN_PARA\n';
                    break;
            }
            
            return text;
        }
        
        function convertTextToBlocks() {
            const code = document.getElementById('codeEditor').value;
            
            if (!code.trim() || code.trim().startsWith('//')) {
                alert('‚ö†Ô∏è Escribe c√≥digo antes de convertir');
                return;
            }
            
            try {
                app.blocks = [];
                document.getElementById('workspaceContent').innerHTML = '<p style="color: #999; text-align: center; margin-top: 100px;" id="emptyMessage">Arrastra bloques aqu√≠ para construir tu programa</p>';
                
                parseCodeToBlocks(code);
                switchMode('blocks');
                
                alert('‚úì C√≥digo convertido a bloques exitosamente');
            } catch (e) {
                alert('‚ùå Error al parsear el c√≥digo:\n' + e.message);
            }
        }
        
        function executeTextCode() {
            const code = document.getElementById('codeEditor').value;
            if (!code.trim()) {
                alert('‚ö†Ô∏è Escribe c√≥digo antes de ejecutar');
                return;
            }
            
            try {
                const tempBlocks = app.blocks;
                app.blocks = [];
                parseCodeToBlocks(code);
                executeProgram();
                app.blocks = tempBlocks;
            } catch (e) {
                alert('‚ùå Error:\n' + e.message);
            }
        }
        
        function parseCodeToBlocks(code) {
            const lines = code.split('\n').map(line => line.trimEnd());
            let currentY = 50;
            const blockStack = [];
            
            const varPattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
            const foundVars = new Set();
            lines.forEach(line => {
                if (line.includes('LEER') || line.includes('CALCULAR') || line.includes('PARA')) {
                    const matches = line.matchAll(varPattern);
                    for (const match of matches) {
                        if (!['LEER', 'CALCULAR', 'PARA', 'DESDE', 'HASTA', 'SI', 'ENTONCES', 'MIENTRAS', 'HACER', 'ESCRIBIR', 'INICIO', 'FIN'].includes(match[1])) {
                            foundVars.add(match[1]);
                        }
                    }
                }
            });
            
            foundVars.forEach(varName => {
                if (!app.variableNames.includes(varName)) {
                    app.variableNames.push(varName);
                }
            });
            renderVariablesList();
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                if (!trimmed || trimmed.startsWith('//')) continue;
                
                const isTopLevel = blockStack.length === 0;
                let parentBlock = blockStack.length > 0 ? blockStack[blockStack.length - 1] : null;
                
                if (trimmed === 'INICIO') {
                    if (isTopLevel) { createBlockFromText('start', 50, currentY); currentY += 80; }
                } else if (trimmed === 'FIN') {
                    if (isTopLevel) { createBlockFromText('end', 50, currentY); currentY += 80; }
                } else if (trimmed.startsWith('LEER')) {
                    const match = trimmed.match(/LEER\s+(\w+)(?:\s+'([^']*)')?/);
                    if (match) {
                        const blockData = { variable: match[1], message: match[2] || '' };
                        if (isTopLevel) { createBlockFromText('input', 50, currentY, blockData); currentY += 100; }
                        else if (parentBlock) createNestedBlockFromText('input', parentBlock, blockData);
                    }
                } else if (trimmed.startsWith('ESCRIBIR')) {
                    const match = trimmed.match(/ESCRIBIR\s+(?:'([^']*)')?(?:\s+)?(\w+)?/);
                    if (match) {
                        const blockData = { message: match[1] || '', variable: match[2] || '' };
                        if (isTopLevel) { createBlockFromText('output', 50, currentY, blockData); currentY += 100; }
                        else if (parentBlock) createNestedBlockFromText('output', parentBlock, blockData);
                    }
                } else if (trimmed.startsWith('CALCULAR')) {
                    const match = trimmed.match(/CALCULAR\s+(\w+)\s*=\s*(.+)/);
                    if (match) {
                        const blockData = { targetVar: match[1], expression: match[2].trim() };
                        if (isTopLevel) { createBlockFromText('calculate', 50, currentY, blockData); currentY += 90; }
                        else if (parentBlock) createNestedBlockFromText('calculate', parentBlock, blockData);
                    }
                } else if (trimmed.startsWith('SI')) {
                    const match = trimmed.match(/SI\s+(.+?)\s+ENTONCES/);
                    if (match) {
                        const blockData = { condition: match[1] };
                        let newBlock;
                        if (isTopLevel) { newBlock = createBlockFromText('if', 50, currentY, blockData); currentY += 200; }
                        else if (parentBlock) newBlock = createNestedBlockFromText('if', parentBlock, blockData);
                        if (newBlock) blockStack.push(newBlock);
                    }
                } else if (trimmed === 'FIN_SI') {
                    if (blockStack.length > 0 && blockStack[blockStack.length - 1].type === 'if') blockStack.pop();
                } else if (trimmed === 'SINO') {
                    if (blockStack.length > 0 && blockStack[blockStack.length - 1].type === 'if') blockStack.pop();
                    const blockData = {};
                    let newBlock;
                    const actualParent = blockStack.length > 0 ? blockStack[blockStack.length - 1] : null;
                    if (actualParent) newBlock = createNestedBlockFromText('else', actualParent, blockData);
                    else { newBlock = createBlockFromText('else', 50, currentY, blockData); currentY += 200; }
                    if (newBlock) blockStack.push(newBlock);
                } else if (trimmed === 'FIN_SINO') {
                    if (blockStack.length > 0 && blockStack[blockStack.length - 1].type === 'else') blockStack.pop();
                } else if (trimmed.startsWith('MIENTRAS')) {
                    const match = trimmed.match(/MIENTRAS\s+(.+?)\s+HACER/);
                    if (match) {
                        const blockData = { condition: match[1] };
                        let newBlock;
                        if (isTopLevel) { newBlock = createBlockFromText('while', 50, currentY, blockData); currentY += 200; }
                        else if (parentBlock) newBlock = createNestedBlockFromText('while', parentBlock, blockData);
                        if (newBlock) blockStack.push(newBlock);
                    }
                } else if (trimmed === 'FIN_MIENTRAS') {
                    if (blockStack.length > 0 && blockStack[blockStack.length - 1].type === 'while') blockStack.pop();
                } else if (trimmed.startsWith('PARA')) {
                    const match = trimmed.match(/PARA\s+(\w+)\s+DESDE\s+(.+?)\s+HASTA\s+(.+)/);
                    if (match) {
                        const blockData = { variable: match[1], start: match[2].trim(), end: match[3].trim() };
                        let newBlock;
                        if (isTopLevel) { newBlock = createBlockFromText('for', 50, currentY, blockData); currentY += 200; }
                        else if (parentBlock) newBlock = createNestedBlockFromText('for', parentBlock, blockData);
                        if (newBlock) blockStack.push(newBlock);
                    }
                } else if (trimmed === 'FIN_PARA') {
                    if (blockStack.length > 0 && blockStack[blockStack.length - 1].type === 'for') blockStack.pop();
                }
            }
            
            const emptyMsg = document.getElementById('emptyMessage');
            if (emptyMsg && app.blocks.length > 0) emptyMsg.style.display = 'none';
        }
        
        function createBlockFromText(type, x, y, data = {}) {
            const blockId = `block_${app.blockCounter++}`;
            const block = { id: blockId, type: type, x: x, y: y, data: data, children: [] };
            app.blocks.push(block);
            renderBlock(block);
            return block;
        }
        
        function createNestedBlockFromText(type, parentBlock, data = {}) {
            const blockId = `block_${app.blockCounter++}`;
            const block = { id: blockId, type: type, data: data, parent: parentBlock.id, isNested: true, children: [] };
            app.blocks.push(block);
            if (!parentBlock.children) parentBlock.children = [];
            parentBlock.children.push(blockId);
            renderNestedBlock(block, parentBlock.id);
            return block;
        }
        
        function zoomIn() { app.zoomLevel = Math.min(app.zoomLevel + 0.1, 2); applyZoom(); }
        function zoomOut() { app.zoomLevel = Math.max(app.zoomLevel - 0.1, 0.3); applyZoom(); }
        function zoomReset() { app.zoomLevel = 1; applyZoom(); }
        
        function applyZoom() {
            const workspaceContent = document.getElementById('workspaceContent');
            workspaceContent.style.transform = `scale(${app.zoomLevel})`;
            const baseHeight = 3000;
            workspaceContent.style.minHeight = `${baseHeight * app.zoomLevel}px`;
            const zoomPercent = Math.round(app.zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = `${zoomPercent}%`;
        }

        function setupEventListeners() {
            const workspace = document.getElementById('workspace');
            
            document.querySelectorAll('.palette-block').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('blockType', e.target.dataset.type);
                    e.dataTransfer.setData('fromPalette', 'true');
                    e.target.style.opacity = '0.5';
                });
                block.addEventListener('dragend', (e) => { e.target.style.opacity = '1'; });
            });

            workspace.addEventListener('dragover', (e) => { e.preventDefault(); });
            workspace.addEventListener('drop', (e) => {
                e.preventDefault();
                const blockType = e.dataTransfer.getData('blockType');
                const fromPalette = e.dataTransfer.getData('fromPalette');
                if (!fromPalette || !blockType) return;
                const rect = workspace.getBoundingClientRect();
                const x = e.clientX - rect.left + workspace.scrollLeft - 10;
                const y = e.clientY - rect.top + workspace.scrollTop - 10;
                createBlock(blockType, x, y);
                const emptyMsg = document.getElementById('emptyMessage');
                if (emptyMsg) emptyMsg.style.display = 'none';
            });
            workspace.addEventListener('click', (e) => {
                if (e.target.id === 'workspace' || e.target.id === 'workspaceContent' || e.target.id === 'emptyMessage') {
                    deselectAll();
                }
            });
        }

        function createBlock(type, x, y) {
            const blockId = `block_${app.blockCounter++}`;
            const block = { id: blockId, type: type, x: x, y: y, data: {}, children: [] };
            app.blocks.push(block);
            renderBlock(block);
        }

        function renderBlock(block) {
            const workspaceContent = document.getElementById('workspaceContent');
            const blockEl = document.createElement('div');
            blockEl.className = `workspace-block block-${block.type}`;
            blockEl.id = block.id;
            blockEl.style.left = `${block.x}px`;
            blockEl.style.top = `${block.y}px`;
            
            blockEl.onclick = (e) => {
                if (e.target.tagName === 'INPUT' || e.target.classList.contains('block-slot')) return;
                e.stopPropagation();
                selectBlock(block.id);
            };

            switch(block.type) {
                case 'start':
                    blockEl.className += ' block-control block-start';
                    blockEl.innerHTML = 'üèÅ INICIO';
                    break;
                case 'end':
                    blockEl.className += ' block-control block-end';
                    blockEl.innerHTML = 'üèÅ FIN';
                    break;
                case 'input':
                    blockEl.className += ' block-data';
                    blockEl.innerHTML = `<div>üì• <strong>LEER DEL TECLADO</strong></div><input class="block-input" placeholder="Mensaje..." value="${block.data.message || ''}" oninput="updateBlockData('${block.id}', 'message', this.value)"><div style="margin-top: 6px;">Guardar en: <span class="block-slot ${block.data.variable ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'variable')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.variable || 'variable'}</span></div>`;
                    break;
                case 'output':
                    blockEl.className += ' block-data';
                    blockEl.innerHTML = `<div>üì§ <strong>ESCRIBIR EN PANTALLA</strong></div><input class="block-input" placeholder="Mensaje..." value="${block.data.message || ''}" oninput="updateBlockData('${block.id}', 'message', this.value)"><div style="margin-top: 6px;">Mostrar: <span class="block-slot ${block.data.variable ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'variable')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.variable || 'variable'}</span></div>`;
                    break;
                case 'calculate':
                    blockEl.className += ' block-operator';
                    blockEl.innerHTML = `<div>üßÆ <strong>CALCULAR</strong></div><div style="margin-top: 6px;"><span class="block-slot ${block.data.targetVar ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'targetVar')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.targetVar || 'variable'}</span> = <input class="block-input" style="width: 140px;" placeholder="expresi√≥n (a+b)" value="${block.data.expression || ''}" oninput="updateBlockData('${block.id}', 'expression', this.value)"></div>`;
                    break;
                case 'if':
                    blockEl.className += ' block-condition';
                    blockEl.style.minWidth = '300px';
                    blockEl.innerHTML = `<div><strong>SI</strong> <input class="block-input" style="width: 160px;" placeholder="condici√≥n (a>5)" value="${block.data.condition || ''}" oninput="updateBlockData('${block.id}', 'condition', this.value)"> <strong>ENTONCES</strong></div><div class="block-container" id="container_${block.id}" ondrop="dropIntoContainer(event, '${block.id}')" ondragover="event.preventDefault(); event.currentTarget.classList.add('drop-active')" ondragleave="event.currentTarget.classList.remove('drop-active')"><div id="children_${block.id}"></div></div>`;
                    break;
                case 'else':
                    blockEl.className += ' block-condition';
                    blockEl.style.minWidth = '300px';
                    blockEl.innerHTML = `<div><strong>SINO</strong></div><div class="block-container" id="container_${block.id}" ondrop="dropIntoContainer(event, '${block.id}')" ondragover="event.preventDefault(); event.currentTarget.classList.add('drop-active')" ondragleave="event.currentTarget.classList.remove('drop-active')"><div id="children_${block.id}"></div></div>`;
                    break;
                case 'while':
                    blockEl.className += ' block-control';
                    blockEl.style.background = '#9C27B0';
                    blockEl.style.minWidth = '300px';
                    blockEl.innerHTML = `<div><strong>üîÅ MIENTRAS</strong> <input class="block-input" style="width: 140px;" placeholder="condici√≥n (i<10)" value="${block.data.condition || ''}" oninput="updateBlockData('${block.id}', 'condition', this.value)"> <strong>HACER</strong></div><div class="block-container" id="container_${block.id}" ondrop="dropIntoContainer(event, '${block.id}')" ondragover="event.preventDefault(); event.currentTarget.classList.add('drop-active')" ondragleave="event.currentTarget.classList.remove('drop-active')"><div id="children_${block.id}"></div></div>`;
                    break;
                case 'for':
                    blockEl.className += ' block-control';
                    blockEl.style.background = '#673AB7';
                    blockEl.style.minWidth = '350px';
                    blockEl.innerHTML = `<div><strong>üîÇ PARA</strong></div><div style="margin-top: 6px; font-size: 11px;"><span class="block-slot ${block.data.variable ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'variable')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.variable || 'i'}</span> desde <input class="block-input" style="width: 50px;" placeholder="1" value="${block.data.start || ''}" oninput="updateBlockData('${block.id}', 'start', this.value)"> hasta <input class="block-input" style="width: 50px;" placeholder="10" value="${block.data.end || ''}" oninput="updateBlockData('${block.id}', 'end', this.value)"></div><div class="block-container" id="container_${block.id}" ondrop="dropIntoContainer(event, '${block.id}')" ondragover="event.preventDefault(); event.currentTarget.classList.add('drop-active')" ondragleave="event.currentTarget.classList.remove('drop-active')"><div id="children_${block.id}"></div></div>`;
                    break;
            }

            makeDraggable(blockEl);
            workspaceContent.appendChild(blockEl);
        }

        function makeDraggable(element) {
            let isDragging = false, offsetX = 0, offsetY = 0;
            element.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.classList.contains('block-slot') || e.target.classList.contains('block-container')) return;
                isDragging = true;
                element.style.zIndex = '100';
                const rect = element.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                e.preventDefault();
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const workspace = document.getElementById('workspace');
                const workspaceRect = workspace.getBoundingClientRect();
                let newX = e.clientX - workspaceRect.left - offsetX + workspace.scrollLeft;
                let newY = e.clientY - workspaceRect.top - offsetY + workspace.scrollTop;
                newX = Math.max(0, newX);
                newY = Math.max(0, newY);
                element.style.left = `${newX}px`;
                element.style.top = `${newY}px`;
                const block = app.blocks.find(b => b.id === element.id);
                if (block) { block.x = newX; block.y = newY; }
            });
            document.addEventListener('mouseup', () => {
                if (isDragging) { isDragging = false; element.style.zIndex = '10'; }
            });
        }

        function selectBlock(blockId) {
            deselectAll();
            app.selectedBlockId = blockId;
            const blockEl = document.getElementById(blockId);
            if (blockEl) blockEl.classList.add('selected');
            const block = app.blocks.find(b => b.id === blockId);
            const infoEl = document.getElementById('selectedBlockInfo');
            if (infoEl && block) {
                const typeNames = { 'start': 'INICIO', 'end': 'FIN', 'input': 'LEER', 'output': 'ESCRIBIR', 'calculate': 'CALCULAR', 'if': 'SI', 'else': 'SINO', 'while': 'MIENTRAS', 'for': 'PARA' };
                infoEl.innerHTML = `<strong>‚úì Seleccionado:</strong><br>${typeNames[block.type] || block.type}`;
                infoEl.classList.add('active');
            }
        }

        function deselectAll() {
            app.selectedBlockId = null;
            document.querySelectorAll('.workspace-block').forEach(el => el.classList.remove('selected'));
            const infoEl = document.getElementById('selectedBlockInfo');
            if (infoEl) { infoEl.innerHTML = 'Ning√∫n bloque seleccionado'; infoEl.classList.remove('active'); }
        }

        function deleteSelectedBlock() {
            if (!app.selectedBlockId) { alert('Primero selecciona un bloque haciendo clic sobre √©l'); return; }
            const blockIndex = app.blocks.findIndex(b => b.id === app.selectedBlockId);
            if (blockIndex > -1) {
                const blockEl = document.getElementById(app.selectedBlockId);
                if (blockEl) blockEl.remove();
                app.blocks.splice(blockIndex, 1);
                const infoEl = document.getElementById('selectedBlockInfo');
                if (infoEl) {
                    infoEl.innerHTML = '‚úì Bloque eliminado';
                    infoEl.classList.remove('active');
                    setTimeout(() => { infoEl.innerHTML = 'Ning√∫n bloque seleccionado'; }, 1500);
                }
                app.selectedBlockId = null;
            }
        }

        function updateBlockData(blockId, key, value) {
            const block = app.blocks.find(b => b.id === blockId);
            if (block) block.data[key] = value;
        }

        function dropVariable(event, blockId, slotName) {
            event.preventDefault();
            event.stopPropagation();
            event.target.classList.remove('drop-target');
            const varName = event.dataTransfer.getData('varName');
            if (varName) {
                const block = app.blocks.find(b => b.id === blockId);
                if (block) {
                    block.data[slotName] = varName;
                    event.target.textContent = varName;
                    event.target.classList.add('filled');
                }
            }
        }

        function dropIntoContainer(event, parentBlockId) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drop-active');
            const blockType = event.dataTransfer.getData('blockType');
            const fromPalette = event.dataTransfer.getData('fromPalette');
            if (fromPalette && blockType) {
                const newBlock = { id: `block_${app.blockCounter++}`, type: blockType, data: {}, parent: parentBlockId, isNested: true, children: [] };
                app.blocks.push(newBlock);
                const parentBlock = app.blocks.find(b => b.id === parentBlockId);
                if (parentBlock) {
                    if (!parentBlock.children) parentBlock.children = [];
                    parentBlock.children.push(newBlock.id);
                }
                renderNestedBlock(newBlock, parentBlockId);
            }
        }

        function renderNestedBlock(block, parentId) {
            const container = document.getElementById(`children_${parentId}`);
            if (!container) return;
            const blockEl = document.createElement('div');
            blockEl.className = `nested-block block-${block.type}`;
            blockEl.id = block.id;
            const colors = { 'input': '#FF6680', 'output': '#FF6680', 'calculate': '#59C059', 'if': '#5CB1D6', 'else': '#5CB1D6', 'while': '#9C27B0', 'for': '#673AB7' };
            blockEl.style.background = colors[block.type] || '#999';
            blockEl.style.color = 'white';
            blockEl.style.padding = '8px 12px';
            blockEl.style.borderRadius = '6px';
            blockEl.style.fontSize = '12px';
            blockEl.style.marginBottom = '5px';
            blockEl.style.cursor = 'pointer';
            blockEl.onclick = (e) => {
                if (e.target.tagName === 'INPUT' || e.target.classList.contains('block-slot')) return;
                e.stopPropagation();
                selectBlock(block.id);
            };
            switch(block.type) {
                case 'input':
                    blockEl.innerHTML = `<div>üì• <strong>LEER</strong></div><input class="block-input" placeholder="Mensaje..." value="${block.data.message || ''}" oninput="updateBlockData('${block.id}', 'message', this.value)"><div>Guardar en: <span class="block-slot ${block.data.variable ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'variable')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.variable || 'variable'}</span></div>`;
                    break;
                case 'output':
                    blockEl.innerHTML = `<div>üì§ <strong>ESCRIBIR</strong></div><input class="block-input" placeholder="Mensaje..." value="${block.data.message || ''}" oninput="updateBlockData('${block.id}', 'message', this.value)"><div>Mostrar: <span class="block-slot ${block.data.variable ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'variable')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.variable || 'variable'}</span></div>`;
                    break;
                case 'calculate':
                    blockEl.innerHTML = `<div>üßÆ <strong>CALCULAR</strong></div><span class="block-slot ${block.data.targetVar ? 'filled' : ''}" ondrop="dropVariable(event, '${block.id}', 'targetVar')" ondragover="event.preventDefault(); event.target.classList.add('drop-target')" ondragleave="event.target.classList.remove('drop-target')">${block.data.targetVar || 'var'}</span> = <input class="block-input" style="width: 100px;" placeholder="expresi√≥n" value="${block.data.expression || ''}" oninput="updateBlockData('${block.id}', 'expression', this.value)">`;
                    break;
                default:
                    blockEl.textContent = `${block.type}`;
            }
            container.appendChild(blockEl);
        }

        function createVariable() {
            const varName = prompt('Nombre de la variable:');
            if (varName && varName.trim()) {
                const cleanName = varName.trim().replace(/[^a-zA-Z0-9_]/g, '');
                if (cleanName && !app.variableNames.includes(cleanName)) {
                    app.variableNames.push(cleanName);
                    renderVariablesList();
                }
            }
        }

        function renderVariablesList() {
            const list = document.getElementById('variablesList');
            list.innerHTML = app.variableNames.map(name => `<div class="variable-item" draggable="true" data-varname="${name}">${name}</div>`).join('');
            list.querySelectorAll('.variable-item').forEach(item => {
                item.addEventListener('dragstart', (e) => { e.dataTransfer.setData('varName', e.target.dataset.varname); });
            });
        }

        async function executeProgram() {
            app.variables = {};
            app.output = [];
            const topBlocks = app.blocks.filter(b => !b.isNested).sort((a, b) => a.y - b.y);
            for (const block of topBlocks) { await executeBlock(block); }
            showOutput();
            showVariables();
        }

        async function executeBlock(block) {
            const blockEl = document.getElementById(block.id);
            if (blockEl) {
                blockEl.classList.add('executing');
                await new Promise(r => setTimeout(r, 500));
            }
            switch(block.type) {
                case 'start': app.output.push('‚ñ∂Ô∏è Iniciando programa...'); break;
                case 'end': app.output.push('‚úÖ Programa finalizado'); break;
                case 'input':
                    if (block.data.variable) {
                        const msg = block.data.message || `Valor para ${block.data.variable}:`;
                        const val = prompt(msg);
                        app.variables[block.data.variable] = isNaN(val) ? val : parseFloat(val);
                        app.output.push(`üì• LEER: ${block.data.variable} = ${app.variables[block.data.variable]}`);
                        showVariables();
                    }
                    break;
                case 'output':
                    let txt = block.data.message || '';
                    if (block.data.variable) {
                        const val = app.variables[block.data.variable];
                        txt += (txt ? ' ' : '') + (val !== undefined ? val : '[no definida]');
                    }
                    app.output.push(`üì§ ESCRIBIR: ${txt}`);
                    break;
                case 'calculate':
                    if (block.data.targetVar && block.data.expression) {
                        try {
                            const before = app.variables[block.data.targetVar];
                            const result = evaluateExpression(block.data.expression);
                            app.variables[block.data.targetVar] = result;
                            if (before !== undefined) app.output.push(`üßÆ ${block.data.targetVar}: ${before} ‚Üí ${result}`);
                            else app.output.push(`üßÆ ${block.data.targetVar} = ${result}`);
                            showVariables();
                        } catch (e) { app.output.push(`‚ùå Error: ${e.message}`); }
                    }
                    break;
                case 'if':
                    if (block.data.condition) {
                        try {
                            const result = evaluateExpression(block.data.condition);
                            app.output.push(`üîÄ SI "${block.data.condition}" = ${result ? 'VERDADERO' : 'FALSO'}`);
                            if (result && block.children && block.children.length > 0) {
                                for (const childId of block.children) {
                                    const child = app.blocks.find(b => b.id === childId);
                                    if (child) await executeBlock(child);
                                }
                            }
                        } catch (e) { app.output.push(`‚ùå Error: ${e.message}`); }
                    }
                    break;
                case 'for':
                    const varName = block.data.variable;
                    const start = block.data.start ? parseInt(block.data.start) : 1;
                    const end = block.data.end ? parseInt(block.data.end) : 10;
                    if (!varName) { app.output.push(`‚ö†Ô∏è PARA: Falta asignar la variable de control`); break; }
                    const currentBlock = app.blocks.find(b => b.id === block.id);
                    const childrenIds = currentBlock && currentBlock.children ? currentBlock.children : [];
                    app.output.push(`üîÇ PARA: ${varName} de ${start} a ${end}`);
                    for (let i = start; i <= end; i++) {
                        app.variables[varName] = i;
                        app.output.push(`   üìç ${varName} = ${i}`);
                        showVariables();
                        if (childrenIds.length > 0) {
                            for (const childId of childrenIds) {
                                const child = app.blocks.find(b => b.id === childId);
                                if (child) await executeBlock(child);
                            }
                        } else { app.output.push(`   ‚ö†Ô∏è Sin instrucciones`); }
                        showOutput();
                    }
                    app.output.push(`‚úì Ciclo completado`);
                    break;
                case 'while':
                    if (block.data.condition) {
                        app.output.push(`üîÅ MIENTRAS: "${block.data.condition}"`);
                        let iter = 0;
                        const max = 100;
                        try {
                            let cond = evaluateExpression(block.data.condition);
                            while (cond && iter < max) {
                                iter++;
                                app.output.push(`   üìç Iteraci√≥n ${iter}`);
                                if (block.children && block.children.length > 0) {
                                    for (const childId of block.children) {
                                        const child = app.blocks.find(b => b.id === childId);
                                        if (child) await executeBlock(child);
                                    }
                                }
                                cond = evaluateExpression(block.data.condition);
                                showOutput();
                            }
                            if (iter >= max) app.output.push(`‚ö†Ô∏è Detenido: ${max} iteraciones`);
                            else app.output.push(`‚úì Ciclo completado: ${iter} iteraciones`);
                        } catch (e) { app.output.push(`‚ùå Error: ${e.message}`); }
                    }
                    break;
            }
            if (blockEl) blockEl.classList.remove('executing');
            showOutput();
        }

        function evaluateExpression(expr) {
            let sanitized = expr;
            for (let varName in app.variables) {
                const regex = new RegExp('\\b' + varName + '\\b', 'g');
                sanitized = sanitized.replace(regex, app.variables[varName]);
            }
            const mathFunctions = { sqrt: Math.sqrt, pow: Math.pow, abs: Math.abs, floor: Math.floor, ceil: Math.ceil, round: Math.round, sin: Math.sin, cos: Math.cos, tan: Math.tan, log: Math.log, exp: Math.exp, min: Math.min, max: Math.max };
            const funcBody = `with (mathContext) { return (${sanitized}); }`;
            try {
                const func = new Function('mathContext', funcBody);
                return func(mathFunctions);
            } catch (e) { throw new Error('Expresi√≥n inv√°lida: ' + expr); }
        }

        function showOutput() {
            const outputArea = document.getElementById('outputArea');
            outputArea.innerHTML = app.output.map(line => {
                if (line.includes('‚ñ∂Ô∏è') || line.includes('‚úÖ')) return `<div style="color: #2196F3; font-weight: bold;">${line}</div>`;
                if (line.includes('üì•') || line.includes('üßÆ')) return `<div style="color: #4CAF50;">${line}</div>`;
                if (line.includes('üì§')) return `<div style="color: #FF6680; font-weight: bold;">${line}</div>`;
                if (line.includes('üîÄ') || line.includes('üîÅ') || line.includes('üîÇ')) return `<div style="color: #9C27B0; font-weight: bold;">${line}</div>`;
                if (line.includes('   ')) return `<div style="color: #666; margin-left: 20px; font-size: 11px;">${line}</div>`;
                if (line.includes('‚ùå')) return `<div style="color: #f44336; font-weight: bold;">${line}</div>`;
                return `<div>${line}</div>`;
            }).join('') || '<div style="color: #999;">Programa ejecutado</div>';
            outputArea.scrollTop = outputArea.scrollHeight;
        }

        function showVariables() {
            const display = document.getElementById('variablesDisplay');
            if (Object.keys(app.variables).length === 0) {
                display.innerHTML = '<p style="color: #666; font-size: 11px;">No hay variables definidas</p>';
                return;
            }
            display.innerHTML = Object.entries(app.variables).map(([name, value]) => `<div class="variable-value-item"><span class="var-name">${name}</span><span class="var-value">${value}</span></div>`).join('');
        }

        function resetExecution() {
            app.variables = {};
            app.output = [];
            document.querySelectorAll('.workspace-block').forEach(block => block.classList.remove('executing'));
            document.getElementById('outputArea').textContent = 'El resultado aparecer√° aqu√≠...';
            document.getElementById('variablesDisplay').innerHTML = '<p style="color: #666; font-size: 11px;">Las variables aparecer√°n durante la ejecuci√≥n...</p>';
        }

        function clearWorkspace() {
            if (confirm('¬øEliminar todos los bloques y variables?')) {
                app.blocks = [];
                app.variableNames = [];
                document.getElementById('workspaceContent').innerHTML = '<p style="color: #999; text-align: center; margin-top: 100px;" id="emptyMessage">Arrastra bloques aqu√≠ para construir tu programa</p>';
                document.getElementById('variablesList').innerHTML = '';
                document.getElementById('codeEditor').value = '';
                updateSyntaxHighlight();
                resetExecution();
                deselectAll();
            }
        }
        
        function saveAlgorithm() {
            const data = {
                version: '2.0',
                timestamp: new Date().toISOString(),
                zoomLevel: app.zoomLevel,
                variableNames: app.variableNames,
                blocks: app.blocks.map(block => ({
                    id: block.id, type: block.type, x: block.x, y: block.y, data: block.data, children: block.children || [], parent: block.parent, isNested: block.isNested
                }))
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `algoritmo_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úì Algoritmo guardado correctamente');
        }
        
        function loadAlgorithm(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.blocks || !Array.isArray(data.blocks)) { alert('‚ùå Archivo no v√°lido'); return; }
                    app.blocks = [];
                    app.variableNames = data.variableNames || [];
                    app.blockCounter = 0;
                    document.getElementById('workspaceContent').innerHTML = '<p style="color: #999; text-align: center; margin-top: 100px;" id="emptyMessage">Arrastra bloques aqu√≠ para construir tu programa</p>';
                    if (data.zoomLevel) { app.zoomLevel = data.zoomLevel; applyZoom(); }
                    renderVariablesList();
                    const blocksToLoad = data.blocks.sort((a, b) => {
                        if (a.isNested && !b.isNested) return 1;
                        if (!a.isNested && b.isNested) return -1;
                        return 0;
                    });
                    blocksToLoad.forEach(blockData => {
                        const block = { id: blockData.id, type: blockData.type, x: blockData.x || 0, y: blockData.y || 0, data: blockData.data || {}, children: blockData.children || [], parent: blockData.parent, isNested: blockData.isNested };
                        app.blocks.push(block);
                        if (block.isNested && block.parent) renderNestedBlock(block, block.parent);
                        else renderBlock(block);
                        const blockNum = parseInt(block.id.replace('block_', ''));
                        if (!isNaN(blockNum) && blockNum >= app.blockCounter) app.blockCounter = blockNum + 1;
                    });
                    const emptyMsg = document.getElementById('emptyMessage');
                    if (emptyMsg && app.blocks.length > 0) emptyMsg.style.display = 'none';
                    resetExecution();
                    alert('‚úì Algoritmo cargado correctamente');
                } catch (error) { alert('‚ùå Error al cargar el archivo: ' + error.message); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
